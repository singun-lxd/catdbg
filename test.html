<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
        <script src="./lib/cat.js"/></script>
        <script src="./lib/cat_ext.js"/></script>
        <!-- script src="./lib/ali_api.js"/></script -->
        <!-- script src="./lib/ali.js"/></script -->
        <script src="./test.js"/></script>
        <script>
            const jsFunctions = __jsEvalReturn();
            const _cfg = {
                skey: 'test',
                stype: 'test',
                ext: ''
            };
            const _tid = '1';
            let homeData = null;
            let videoId = null;
            let playUrl = null;
            async function _category(page) {
                const extend = JSON.parse(homeData).filters;
                return await jsFunctions.category(_tid, page, null, extend);
            }
            async function _detail(id) {
                return await jsFunctions.detail(id);
            }
            async function _play(id) {
                return await jsFunctions.play(null, id, null);
            }
            async function _search(wd, pg) {
                return await jsFunctions.search(wd, false, pg);
            }
            async function _main() {
                await jsFunctions.init(_cfg);
                homeData = await jsFunctions.home();
                const categoryStr = await _category(1);
                console.log(categoryStr);
                const categoryJson = JSON.parse(categoryStr);
                const vodItem = categoryJson.list[0];
                if (vodItem.vod_id && vodItem.vod_name &&
                    vodItem.vod_pic) {
                    videoId = vodItem.vod_id;
                } else {
                    throw 'item invalid';
                }
                
            }
            _main().then((data)=> {
                console.log("init home success");
            });
            function _playVideo(show, url) {
                const player = document.querySelector('#video_player');
                if (show) {
                    player.attributes.src.nodeValue = url;
                    player.attributes.style.nodeValue = '';
                } else {
                    player.attributes.src.nodeValue = '';
                    player.attributes.style.nodeValue = 'display:none';
                }
            }
            function onClickPage2() {
                _playVideo(false);
                _category(2).then((data) => {
                    console.log(data);
                });
            }
            function onClickDetail() {
                _playVideo(false);
                _detail(videoId).then((data) => {
                    console.log(data);
                    const detailJson = JSON.parse(data);
                    const urlList = detailJson.list[0].vod_play_url;
                    playUrl = urlList.split('#')[0].split('$')[1];
                });
            }
            function onClickPlay() {
                _playVideo(false);
                _play(playUrl).then((data) => {
                    console.log(data);
                    const playData = JSON.parse(data);
                    _playVideo(true, playData.url);
                });
            }
            function onClickSearch() {
                _playVideo(false);
                _search('梅花红桃', 1).then((data) => {
                    console.log(data);
                    const searchJson = JSON.parse(data);
                    const vodItem = searchJson.list[0];
                    if (vodItem.vod_id && vodItem.vod_name &&
                        vodItem.vod_pic) {
                        videoId = vodItem.vod_id;
                    } else {
                        throw 'item invalid';
                    }
                });
            }
        </script>
        <button onclick="onClickPage2()">Page2</button>
        <button onclick="onClickDetail()">Detail</button>
        <button onclick="onClickPlay()">Play</button>
        <button onclick="onClickSearch()">Search</button>
        <video id="video_player" width="320" height="240" autoplay="autoplay" controls="controls" style="display:none" src=""></video>
    </body>
</html>